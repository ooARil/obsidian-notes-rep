Enviroment - это класс, который как и Java Expression Language и SpEL позволяет доставать проперти (так из файла, так из системные переменные).
![[Pasted image 20240415232029.png]]

Но кроме того, у него есть методы для работы с профилями.

Профиль - это строка, которая представляет из себя метку. И на основании этой метки можно включать или выключать какие-то бины или конфигурации.
Пояснение: Т.е. например, профиль, с помощью которого я хочу, выключать некоторые бины в проде.

---

### @Profile

@Profile - используется для определения, в каком контексте приложения должен быть активирован определенный компонент или конфигурация. Это позволяет разработчикам определять, какие бины или компоненты должны быть созданы и доступны в зависимости от активного профиля приложения.
![[Pasted image 20240415232531.png]]
Пояснение: Например, данный бин, будет создан только тогда, когда профиль с котором будет запущено приложение - будет prod.

Замечание: Кроме того, над значением указанном в аннотации @Profile можно проводить логические операции (т.е. : !, &, | и т.д.)
![[Pasted image 20240415232705.png]]
	Т.е. в этом случае бин будет создан тогда, когда профиль будет любым другим, но только не prod.

Пример: когда можно включать/отключать целые классы конфигурации
![[Pasted image 20240415232858.png]]

Как работает?
1. Когда приложение запускается, оно может быть запущено с одним или несколькими активными профилями.
2. Аннотация `@Profile` может быть применена к классам компонентов, конфигурации или методам в конфигурационных классах.
3. Если активный профиль приложения соответствует профилю, указанному в аннотации `@Profile`, то компонент или конфигурация будет создана и станет доступной в контексте приложения.
4. Если активный профиль не соответствует указанному профилю в аннотации `@Profile`, то компонент или конфигурация не будет создана.

---

### Как активировать профиль?

Способы:
1. Самый простой способ - это указать напрямую в properties:
	![[Pasted image 20240415233545.png]]
	Результат:
	![[Pasted image 20240415233633.png]]
	Пояснение: Т.е. нет webConfig и userRepository2 бина.

2. Через Enviroment:
	![[Pasted image 20240415234940.png]]
	Пояснение: 
	- Просто setActiveProfiles() не сработает, т.к. при `new AnnotationConfigApplicationContext(ApplicationConfig.class)` все бины уже созданы. Поэтому не обходимо после этого вызывать метод refresh().
		- refresh() - отвечает за обновление контекста приложения после его создания.
			Когда метод `refresh()` вызывается:
			1. Контекст приложения будет закрыт, если он уже был открыт.
			2. Все ранее созданные бины и компоненты будут уничтожены.
			3. Будет инициирован процесс обновления контекста, включая перечитывание и перезагрузку конфигураций, создание новых бинов и компонентов, привязку зависимостей и так далее.
			4. Контекст приложения будет открыт с обновленными бинами и компонентами.

	- Если сделать просто:
		![[Pasted image 20240415235045.png]]
		то это не сработает, т.к. 
		![[Pasted image 20240415235111.png]]
		refresh() уже вызывается при `new AnnotationConfigApplicationContext(ApplicationConfig.class)`

		Поэтому необходимо вручную вызывать метод register(componentClasses):
		![[Pasted image 20240415235231.png]]
		Замечание: в `new AnnotationConfigApplicationContext()` происходит просто инициализация ридера и сканера [[18. Bean Definition Readers]]:
		![[Pasted image 20240415235308.png]]

		Результат: У нас было указано два профиля `web` и `prod`:
		![[Pasted image 20240415235531.png]]
		

---

### Когда стоит использовать Enviroment?

Enviroment стоит использовать, когда есть какие-то конфигурационные бины (т.е. BeanPostProcessor или BeanFactoryPostProcessor), т.е. те, которые участвуют в жизненном цикле бинов. 
![[image_2024-04-11_12-13-13.png]]
Пояснение: В данном случае пример BeanDefinitionRegistryPostProcessor, который срабатывает до AuthowiredAnnotationBeanPostProcessor (@Value), и единственный вариант остается использовать Enviroment.