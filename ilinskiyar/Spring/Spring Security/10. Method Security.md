---

---

---
### @PreAuthorize и @PostAuthorize

- `@PreAuthroize` - используется для проверки прав доступа до вызова метода/объекта, над которым она стоит:
	![[Pasted image 20240508161916.png]]
	Пояснение:
	- Данную аннотацию можно ставить как над методом, так и над классом.
	- Права доступа проверяются с помощью SpEL. 

	Поэтому используя SpEL и [[#SecurityExpressionRoot]] мы можем описать, какая роль должна быть у пользователя, чтобы использовать метод:
	![[Pasted image 20240508162925.png]]
	Роль пользователя, которая у него должна быть для доступа к этому методу, происходит в `PreAuthorizeAuthorizationManager`:
	![[Pasted image 20240508171321.png]]
	Пояснение: [[#Как происходит проверка прав пользователя на основании аннотаций?]]
	
- `@PostAuthorize` - используется для выполнения какой-либо логики после выполнения метода, к которому она применяется:
	![[Pasted image 20240508182514.png]]
	Пояснение: Т.е. данная аннотация нужна для проверки, что у пользователя есть доступ к данному значению. Если пользователь не имеет прав доступа к возвращаемому значению, метод не будет выполнен и будет выдано исключение `AccessDeniedException`.

	Пояснение: Работает по аналогии с [[#Как происходит проверка прав пользователя на основании аннотаций?]].

---
### @Secured



---
### @PreFilter и @PostFilter


---

### SecurityExpressionRoot

SecurityExpressionRoot - специальный вспомогательный класс, в котором определены публичные методы, которые мы можем использовать в SpEL выражениях, таких аннотациях как [[#@PreAuthorize и @PostAuthorize]] и т.д.:
![[Pasted image 20240508162706.png]]
![[Pasted image 20240508162745.png]]

---
### Как происходит проверка прав пользователя на основании аннотаций?

Когда например ставиться аннотация `@PreAuthorize` в `UserService`:
![[Pasted image 20240508164256.png]]
то у нас создает CGLIB-прокси, а именно `AuthorizationManagerBeforeMethodInterceptor`:
![[Pasted image 20240508165934.png]]
	Пояснение: `AuthorizationManagerBeforeMethodInterceptor` создается он как бин (это тема AOP):
		![[Pasted image 20240508170023.png]]

и как можно увидеть, то будет вызываться `PreAuthorizeAuthorizationManager`:
![[Pasted image 20240508170309.png]]

И получается, что когда у нас срабатывает метод, помеченный аннотацией `@PreAuthrorize` происходит следующее:
1. Вызывается наш прокси-класс, в методе которого стояла данная аннотация:
	![[Pasted image 20240508170644.png]]

2. После чего в `AuthorizationManagerBeforeMethodInterceptor` срабатывает метод `invoke`:
	![[Pasted image 20240508170738.png]]
	![[Pasted image 20240508170849.png]]

	который вызывает метод `attemptAuthorization`, в котором вызывается `PreAuthorizeAuthorizationManager`, который был задан в бине.
	![[Pasted image 20240508171128.png]]
	![[Pasted image 20240508171329.png]]