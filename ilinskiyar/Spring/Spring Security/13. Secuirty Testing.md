Теперь настроив Spring Secuirty, если мы запустим наши интеграционные тесты:
![[Pasted image 20240520165827.png]]
то вместо 2хх-ого статуса, мы получим 302 (т.е. редирект страницы):
![[Pasted image 20240520170804.png]]
Пояснение: Потому что нам необходимо пройти аутентификацию, поэтому нас редиректит на страницу `/login`.

Нам не нужно проходить аутентификацию, как мы это делали ранее на форме, для тестов, нам нужно просто внедрить пользователя в систему, чтобы мы смогли проверять наш функционал.

Но для этого необходимо подключить зависимость:
![[Pasted image 20240520171220.png]]

Теперь благодаря этой зависимости у нас есть 3 варианта протестировать наш функционал **с уже аутентифицированным пользователем**:
1. Вручную установить SecuirtyContext [[2. Authentication Filter - Architecture#Модель хранения пользователя]]:
	![[Pasted image 20240520171427.png]]
	Пояснение: 
	- Т.е. перед каждым методом мы инициализируем нашего пользователя. Т.е. используя `SecuirtyContextHolder` мы создаем новый контекст:
		![[Pasted image 20240520192106.png]]
		![[Pasted image 20240520192142.png]]
		И в данный контекст мы должны положить объект `Authentication`.

		И чтобы создать данный объект в `spring-security-test` есть специальный объект `TestingAuthenticationToken`:
		![[Pasted image 20240520192331.png]]
		Пояснение: И в него мы можем передать наш principal (т.е. `User`), credentials (т.е. пароль) и authorities (т.е. роли):
		![[Pasted image 20240520193039.png]]
		
		После чего просто помещаем `Authentication` в `SecurityContext`:
		![[Pasted image 20240520193134.png]]

		И чтобы у нас был доступ к этому контексту передаем его в `SecuirtyContextHolder`:
		![[Pasted image 20240520193222.png]]

	И запустив тест теперь получаем 2хх-ый статус:
	![[Pasted image 20240520193326.png]]

2. Установить `Authentication` в `SecurityContext` с помощью аннотации `@WithMockUser`:
	![[Pasted image 20240520193433.png]]
	Пояснение:
	- В ней все просто:
		![[Pasted image 20240520193523.png]]

	И запустим тест получаем 2хх:
	![[Pasted image 20240520193644.png]]

	Замечание:
	- Кроме того данную аннотацию мы можем ставить над классом. Благодаря этому на все методы будет распространяться наш тестовый пользователь прошедший аутентификацию:
		![[Pasted image 20240520193809.png]]

	  И даже если мы хотим, что над каким-то конкретным методом, были другие роли, мы можем просто поставить над ним аннотацию:
	    ![[Pasted image 20240520193932.png]]
	  и она просто замениться для данного метода  (так работают все аннотации в Spring)

3. Также мы прямо в запросе можем указать аутентифицированного пользователя:
	![[Pasted image 20240520194345.png]]
	Пояснение: 
	- `with()` - нужен чтобы добавить какие-то дополнительные настройки (`RequestPostProcessor`) для запроса **перед его отправкой**:
		![[Pasted image 20240520194546.png]]
	- `SecurityMockMvcRequestPostProcessors` - это как раз набор полезных `RequestPostProcessor` для тестирования Spring Security. 
		Они позволяют легко настроить **аутентификацию** и **авторизацию** в тестовых запросах, чтобы имитировать различные состояния безопасности, такие как аутентификация пользователя, установка роли или права доступа.
		![[Pasted image 20240520194759.png]]

	И при запуске получаем 2хх:
	![[Pasted image 20240520195010.png]]
	